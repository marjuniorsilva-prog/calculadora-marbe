<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sistema Marbe v14.0 - Financeiro</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root { --primary: #2c7be5; --success: #28a745; --danger: #d9534f; --info: #17a2b8; --warning: #f6c23e; --dark: #333; }
    body { font-family: sans-serif; background: #f4f7f6; margin: 0; padding: 10px; }
    .container { max-width: 1000px; background: #fff; padding: 20px; border-radius: 12px; margin: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    
    .tabs { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab-btn { flex: 1; padding: 12px; border: none; background: #ddd; cursor: pointer; font-weight: bold; border-radius: 8px; font-size: 10px; min-width: 80px; text-transform: uppercase; }
    .tab-btn.active { background: var(--primary); color: white; }
    
    .content-section { display: none; }
    .content-section.active { display: block; }

    label { display: block; margin-top: 10px; font-weight: bold; color: #444; font-size: 13px; }
    input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
    .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; color: white; font-size: 14px; }
    
    table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
    table th, table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    .hist-card { border: 1px solid #ddd; padding: 10px; border-radius: 8px; margin-bottom: 8px; background: #fafafa; }
    
    .status-badge { font-size: 9px; padding: 2px 5px; border-radius: 5px; font-weight: bold; }
    .status-pending { background: #ffeeba; color: #856404; }
    .status-sold { background: #d4edda; color: #155724; }
    .status-delivered { background: #cce5ff; color: #004085; }
    
    .finance-card { border-left: 5px solid var(--primary); padding: 10px; margin-bottom: 10px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  </style>
</head>
<body onload="inicializarSistema()">

<div class="container">
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('calc')">Calc</button>
    <button class="tab-btn" onclick="switchTab('cliente')">Orcam</button>
    <button class="tab-btn" onclick="switchTab('hist')">Vendas</button>
    <button class="tab-btn" onclick="switchTab('entrega')">Entrega/NF</button>
    <button class="tab-btn" onclick="switchTab('receber')" style="background:var(--success); color:white;">Receber</button>
    <button class="tab-btn" onclick="switchTab('dash')">Dash</button>
    <button class="tab-btn" onclick="switchTab('config')">⚙</button>
  </div>

  <div id="sec-calc" class="content-section active">
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
      <div><label>Diam (mm)</label><input type="number" id="diametro"></div>
      <div><label>Comp (mm)</label><input type="number" id="comprimento"></div>
    </div>
    <label>Material</label><select id="borrachaSel"></select>
    <label>Espessura (mm)</label><input type="number" id="espessura">
    <button class="btn" style="background:var(--success)" onclick="calcular()">CALCULAR UNITARIO</button>
    <div id="resumo" style="display:none; padding:10px; background:#eef9f0; margin-top:10px; border-radius:8px; text-align:center"></div>
    <button id="addBtn" class="btn" style="background:#6f42c1; display:none;" onclick="adicionar()">ADICIONAR AO ORCAMENTO</button>
  </div>

  <div id="sec-cliente" class="content-section">
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div><label>OS</label><input type="number" id="numOS" readonly></div>
        <div><label>CNPJ</label><input type="text" id="cnpjCli" onblur="buscarCNPJ(this.value)"></div>
    </div>
    <label>Cliente</label><input type="text" id="razaoCli">
    <div id="listaItensOrc"></div>
    <h3 style="text-align:right">Total: <span id="totalTxt">R$ 0,00</span></h3>
    <button class="btn" style="background:var(--danger)" onclick="gerarPDF('CLIENTE')">GERAR ORCAMENTO PDF</button>
  </div>

  <div id="sec-hist" class="content-section">
    <h2>Vendas Confirmadas</h2>
    <div id="listaHistorico"></div>
  </div>

  <div id="sec-entrega" class="content-section">
    <h2>Entrega e Faturamento (NF)</h2>
    <p style="font-size: 11px; color: #666;">Selecione uma venda confirmada para informar a Nota Fiscal e Boletos.</p>
    <div id="listaParaEntrega"></div>
  </div>

  <div id="sec-receber" class="content-section">
    <h2>Contas a Receber</h2>
    <div id="listaBoletos"></div>
  </div>

  <div id="sec-dash" class="content-section">
    <div id="dashResumo"></div>
    <canvas id="chartMateriais"></canvas>
  </div>

  <div id="sec-config" class="content-section">
    <label>Valor Hora</label><input type="number" id="cfgHora" onchange="salvar()">
    <div id="listaB"></div>
    <button class="btn" style="background:var(--danger)" onclick="limparTudo()">APAGAR TODOS OS DADOS</button>
  </div>
</div>

<script>
  let DB = { vHora: 50, os: 330, mats: [{n: "Natural Preta", p: 13}, {n: "Natural Branca", p: 30}, {n: "Nitrilica", p: 49}], historico: [], financeiro: [] };
  let itens = [];
  let temp = null;

  function inicializarSistema() {
    const s = localStorage.getItem('marbe_v14');
    if(s) DB = JSON.parse(s);
    document.getElementById('numOS').value = DB.os;
    renderConfig();
  }

  function switchTab(t) {
    document.querySelectorAll('.content-section, .tab-btn').forEach(e => e.classList.remove('active'));
    document.getElementById('sec-'+t).classList.add('active');
    event.currentTarget.classList.add('active');
    if(t === 'hist') renderHistorico();
    if(t === 'entrega') renderEntrega();
    if(t === 'receber') renderReceber();
  }

  // --- LOGICA DE HISTORICO E VENDAS ---
  function renderHistorico() {
    const container = document.getElementById('listaHistorico');
    container.innerHTML = DB.historico.slice().reverse().map((h, i) => {
      const idx = DB.historico.length - 1 - i;
      return `
      <div class="hist-card">
        <strong>OS: ${h.os}</strong> | ${h.cliente} | R$ ${h.total.toFixed(2)}
        <div style="margin-top:5px;">
          ${!h.vendido ? `<button onclick="confirmarVenda(${idx})" style="background:var(--success); color:white; border:none; padding:5px; border-radius:3px;">Confirmar Venda</button>` : `<span class="status-badge status-sold">Vendido</span>`}
          <button onclick="regerarPDF(${idx}, 'CLIENTE')" style="background:var(--primary); color:white; border:none; padding:5px; border-radius:3px;">PDF</button>
        </div>
      </div>`;
    }).join('');
  }

  function confirmarVenda(idx) {
    DB.historico[idx].vendido = true;
    salvar(); renderHistorico();
    alert("Venda confirmada! Agora ela aparece na aba Entrega/NF.");
  }

  // --- ABA ENTREGA (LANÇAR NF E PARCELAS) ---
  function renderEntrega() {
    const container = document.getElementById('listaParaEntrega');
    const vendidos = DB.historico.filter(h => h.vendido && !h.entregue);
    if(vendidos.length === 0) { container.innerHTML = "<p>Nenhuma venda pendente de entrega.</p>"; return; }
    
    container.innerHTML = vendidos.map((h) => `
      <div class="hist-card" style="border-top: 3px solid var(--info);">
        <strong>OS: ${h.os} - ${h.cliente}</strong><br>
        Valor: R$ ${h.total.toFixed(2)}<br>
        <div style="background:#eee; padding:10px; margin-top:5px; border-radius:5px;">
          <label>Nº Nota Fiscal</label><input type="text" id="nf_${h.os}" placeholder="Ex: 1234">
          <label>Nº de Parcelas</label><input type="number" id="parc_${h.os}" value="1">
          <button class="btn" style="background:var(--info); font-size:12px;" onclick="finalizarEntrega(${h.os})">FINALIZAR ENTREGA E GERAR BOLETOS</button>
        </div>
      </div>
    `).join('');
  }

  function finalizarEntrega(osNum) {
    const nf = document.getElementById('nf_'+osNum).value;
    const numParc = parseInt(document.getElementById('parc_'+osNum).value);
    if(!nf) return alert("Informe o numero da NF!");

    const venda = DB.historico.find(h => h.os === osNum);
    venda.entregue = true;
    venda.nf = nf;

    // Gerar Parcelas no Financeiro
    const valorParc = venda.total / numParc;
    for(let i=1; i<=numParc; i++) {
        DB.financeiro.push({
            os: osNum,
            cliente: venda.cliente,
            nf: nf,
            parcela: `${i}/${numParc}`,
            valor: valorParc,
            vencimento: "", // Sera preenchido na aba Receber ou via prompt aqui
            pago: false
        });
    }
    salvar(); switchTab('receber');
  }

  // --- ABA RECEBER ---
  function renderReceber() {
    const container = document.getElementById('listaBoletos');
    if(DB.financeiro.length === 0) { container.innerHTML = "<p>Nenhum boleto a receber.</p>"; return; }

    container.innerHTML = DB.financeiro.map((f, idx) => `
      <div class="finance-card" style="border-left-color: ${f.pago ? 'var(--success)' : 'var(--danger)'}">
        <strong>${f.cliente}</strong> (NF: ${f.nf})<br>
        Parcela: ${f.parcela} | <strong>R$ ${f.valor.toFixed(2)}</strong><br>
        Vencimento: <input type="date" value="${f.vencimento}" onchange="DB.financeiro[${idx}].vencimento=this.value; salvar()" style="width:auto; display:inline-block; padding:2px;">
        ${!f.pago ? `<button onclick="baixarBoleto(${idx})" style="background:var(--success); color:white; border:none; padding:5px; border-radius:3px; float:right;">Confirmar Recebimento</button>` : `<span style="color:green; float:right;">PAGO ✓</span>`}
      </div>
    `).join('');
  }

  function baixarBoleto(idx) {
    if(confirm("Confirmar entrada desse valor no caixa?")) {
        DB.financeiro[idx].pago = true;
        salvar(); renderReceber();
    }
  }

  // --- FUNÇÕES AUXILIARES (SALVAR, CALCULAR, ETC) ---
  function salvar() { localStorage.setItem('marbe_v14', JSON.stringify(DB)); }

  function calcular() {
    const d = parseFloat(document.getElementById('diametro').value);
    const l = parseFloat(document.getElementById('comprimento').value);
    const e = parseFloat(document.getElementById('espessura').value);
    const pKg = parseFloat(document.getElementById('borrachaSel').value);
    const peso = Math.ceil((Math.PI * (d + e) * l * e) * 1200 / 1000000000); 
    const vlr = (((peso * pKg) * 1.1 + (10 * DB.vHora)) * 2.5) * 1.045; // Simplificado para exemplo
    temp = { d: "Revestimento", med: d+"x"+l, esp: e+"mm", q: 1, v: vlr, pesoKg: peso, material: "Borracha", vendido: false, entregue: false };
    document.getElementById('resumo').style.display = "block";
    document.getElementById('resumo').innerHTML = "R$ " + vlr.toFixed(2);
    document.getElementById('addBtn').style.display = "block";
  }

  function adicionar() { itens.push({...temp}); switchTab('cliente'); renderItensOrc(); }

  function renderItensOrc() {
    let t = 0;
    itens.forEach(i => t += i.v * i.q);
    document.getElementById('totalTxt').innerText = "R$ " + t.toFixed(2);
  }

  function gerarPDF(t) {
    const dados = { os: DB.os, cliente: document.getElementById('razaoCli').value, total: parseFloat(document.getElementById('totalTxt').innerText.replace("R$ ","")), itens: JSON.parse(JSON.stringify(itens)), vendido: false, entregue: false };
    DB.historico.push(dados);
    DB.os++; salvar();
    alert("Orcamento salvo! Consulte na aba Vendas para confirmar a conclusao.");
  }

  function renderConfig() {
    document.getElementById('borrachaSel').innerHTML = DB.mats.map(m => `<option value="${m.p}">${m.n}</option>`).join('');
  }

  async function buscarCNPJ(v) {
    const r = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${v.replace(/\D/g,'')}`);
    const d = await r.json(); document.getElementById('razaoCli').value = d.razao_social || "";
  }

  function limparTudo() { if(confirm("CUIDADO: Isso apagara todo o historico e financeiro. Confirma?")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>