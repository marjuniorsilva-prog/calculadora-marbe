<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sistema Marbe v8.0</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root { --primary: #2c7be5; --success: #28a745; --danger: #d9534f; }
    body { font-family: sans-serif; background: #f4f7f6; margin: 0; padding: 10px; }
    .container { max-width: 950px; background: #fff; padding: 20px; border-radius: 12px; margin: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .tabs { display: flex; gap: 5px; margin-bottom: 20px; }
    .tab-btn { flex: 1; padding: 12px; border: none; background: #ddd; cursor: pointer; font-weight: bold; border-radius: 8px; }
    .tab-btn.active { background: var(--primary); color: white; }
    .content-section { display: none; }
    .content-section.active { display: block; }
    label { display: block; margin-top: 12px; font-weight: bold; color: #444; }
    input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .row > div { flex: 1; min-width: 140px; }
    .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; color: white; font-size: 16px; }
    .table-container { overflow-x: auto; margin-top: 15px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    table th, table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    .input-table { padding: 5px; border: 1px solid #ccc; width: 100%; }
  </style>
</head>
<body onload="inicializarSistema()">

<div class="container">
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('calc')">Calculadora</button>
    <button class="tab-btn" onclick="switchTab('cliente')">Orcamento</button>
    <button class="tab-btn" onclick="switchTab('config')">Precos</button>
  </div>

  <div id="sec-calc" class="content-section active">
    <div class="row">
      <div><label>Diametro (mm)</label><input type="number" id="diametro"></div>
      <div><label>Comprimento (mm)</label><input type="number" id="comprimento"></div>
    </div>
    <div class="row">
      <div style="flex:2"><label>Material</label><select id="borrachaSel"></select></div>
      <div><label>Espessura (mm)</label><input type="number" id="espessura"></div>
    </div>
    <div class="row">
      <div><label>Horas</label><input type="number" id="horas" value="10"></div>
      <div><label>Ranhura</label><select id="ranhura"><option value="0">Nao</option><option value="300">Sim</option></select></div>
      <div><label>Imposto</label><select id="impostoSel"><option value="0.045">4,5%</option><option value="0.065">6,5%</option></select></div>
    </div>
    <button class="btn" style="background:var(--success)" onclick="calcular()">CALCULAR UNITARIO</button>
    <div id="resumo" style="display:none; padding:10px; background:#eef9f0; margin-top:10px; border-radius:8px; text-align:center"></div>
    <button id="addBtn" class="btn" style="background:#6f42c1; display:none;" onclick="adicionar()">ADICIONAR AO ORCAMENTO</button>
  </div>

  <div id="sec-cliente" class="content-section">
    <div class="row">
        <div><label>Ordem Servico (OS)</label><input type="number" id="numOS" readonly style="background:#eee"></div>
        <div><label>CNPJ Cliente</label><input type="text" id="cnpjCli" onblur="buscarCNPJ(this.value)"></div>
    </div>
    <label>Razao Social Cliente</label>
    <input type="text" id="razaoCli">
    
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Descricao</th>
            <th>Medidas</th>
            <th>Espessura</th>
            <th>Qtd</th>
            <th>Unitario</th>
            <th>Subtotal</th>
            <th>X</th>
          </tr>
        </thead>
        <tbody id="corpoTabela"></tbody>
      </table>
    </div>
    <textarea id="obs" placeholder="Observacoes" style="margin-top:10px"></textarea>
    <h3 style="text-align:right">Total Final: <span id="totalTxt">R$ 0,00</span></h3>
    
    <button class="btn" style="background:var(--danger)" onclick="gerarPDF('CLIENTE')">GERAR PDF PARA CLIENTE</button>
    <button class="btn" style="background:var(--dark); background-color: #333;" onclick="gerarPDF('PRODUCAO')">GERAR PDF PRODUCAO (INTERNO)</button>
  </div>

  <div id="sec-config" class="content-section">
    <label>Valor Hora Producao (R$)</label>
    <input type="number" id="cfgHora" onchange="salvar()">
    <div id="listaB"></div>
    <button class="btn" style="background:var(--primary)" onclick="addMat()">+ Novo Material</button>
  </div>
</div>

<script>
  let DB = { 
    vHora: 50, 
    os: 330, 
    mats: [{n: "Natural Preta", p: 13}, {n: "Natural Branca", p: 30}, {n: "Nitrilica", p: 49}] 
  };
  let itens = [];
  let temp = null;

  function inicializarSistema() {
    const s = localStorage.getItem('marbe_v8');
    if(s) DB = JSON.parse(s);
    if(!DB.os) DB.os = 330;
    document.getElementById('numOS').value = DB.os;
    renderConfig();
  }

  function switchTab(t) {
    document.querySelectorAll('.content-section, .tab-btn').forEach(e => e.classList.remove('active'));
    document.getElementById('sec-'+t).classList.add('active');
    event.currentTarget.classList.add('active');
  }

  function renderConfig() {
    document.getElementById('cfgHora').value = DB.vHora;
    document.getElementById('borrachaSel').innerHTML = DB.mats.map(m => `<option value="${m.p}">${m.n}</option>`).join('');
    document.getElementById('listaB').innerHTML = DB.mats.map((m, i) => `
      <div style="display:flex; gap:5px; margin-top:5px">
        <input type="text" value="${m.n}" readonly>
        <input type="number" value="${m.p}" onchange="DB.mats[${i}].p=parseFloat(this.value); salvar()">
        <button onclick="DB.mats.splice(${i},1); salvar(); renderConfig()">X</button>
      </div>`).join('');
  }

  function addMat() {
    const n = prompt("Nome Material:"); const p = prompt("Preco de Custo (R$/KG):");
    if(n && p) { DB.mats.push({n, p: parseFloat(p)}); salvar(); renderConfig(); }
  }

  function salvar() { 
    DB.vHora = parseFloat(document.getElementById('cfgHora').value);
    localStorage.setItem('marbe_v8', JSON.stringify(DB)); 
  }

  function calcular() {
    const d = parseFloat(document.getElementById('diametro').value);
    const l = parseFloat(document.getElementById('comprimento').value);
    const e = parseFloat(document.getElementById('espessura').value);
    const pKg = parseFloat(document.getElementById('borrachaSel').value);
    const nB = document.getElementById('borrachaSel').options[document.getElementById('borrachaSel').selectedIndex].text;
    
    // Calculo de Peso e Margem
    const pesoLiq = (Math.PI * (d + e) * l * e) * 1200 / 1000000000;
    const pesoFinal = Math.ceil(pesoLiq); 
    const vlr = (((pesoFinal * pKg) * 1.1 + (parseFloat(document.getElementById('horas').value) * DB.vHora) + parseFloat(document.getElementById('ranhura').value)) * 2.5) * (1 + parseFloat(document.getElementById('impostoSel').value));

    temp = { 
        d: "Revestimento em " + nB, 
        m: d+"x"+l+"mm", 
        e: e+"mm", 
        q: 1, 
        v: vlr,
        pesoKg: pesoFinal,
        custoBorracha: pKg,
        material: nB
    };
    document.getElementById('resumo').style.display = "block";
    document.getElementById('resumo').innerHTML = "Unitario Cliente: R$ " + vlr.toFixed(2);
    document.getElementById('addBtn').style.display = "block";
  }

  function adicionar() {
    itens.push({...temp});
    renderTabela();
    switchTab('cliente');
  }

  function renderTabela() {
    const b = document.getElementById('corpoTabela'); b.innerHTML = "";
    let t = 0;
    itens.forEach((it, i) => {
      t += it.v * it.q;
      b.innerHTML += `<tr>
        <td><input class="input-table" value="${it.d}" onchange="itens[${i}].d=this.value"></td>
        <td>${it.m}</td>
        <td><input class="input-table" value="${it.e}" onchange="itens[${i}].e=this.value"></td>
        <td><input type="number" class="input-table" value="${it.q}" onchange="itens[${i}].q=this.value; renderTabela()"></td>
        <td>${it.v.toFixed(2)}</td>
        <td>${(it.v*it.q).toFixed(2)}</td>
        <td onclick="itens.splice(${i},1); renderTabela()" style="color:red;cursor:pointer">X</td>
      </tr>`;
    });
    document.getElementById('totalTxt').innerText = "R$ " + t.toFixed(2);
  }

  async function buscarCNPJ(v) {
    const r = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${v.replace(/\D/g,'')}`);
    const d = await r.json(); document.getElementById('razaoCli').value = d.razao_social || "";
  }

  function gerarPDF(tipo) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const dataAtual = new Date().toLocaleDateString('pt-BR');
    
    // CABECALHO MARBE
    doc.setFont("helvetica", "bold"); doc.setFontSize(16); doc.setTextColor(40);
    doc.text("S B COMERCIO DE BORRACHAS E SERVICOS LTDA", 20, 20);
    doc.setFontSize(9); doc.setFont("helvetica", "normal");
    doc.text("CNPJ: 61.149.312/0001-56", 20, 26);
    doc.text("Endereco: Rua Sao Carlos, 84 - Vila Mariana - Ribeirao Preto / SP", 20, 31);
    doc.line(20, 34, 190, 34);

    // OS E DATA (ENTRE FORNECEDOR E CLIENTE)
    doc.setFontSize(10); doc.setFont("helvetica", "bold");
    doc.text("ORDEM DE SERVICO (OS): " + DB.os, 20, 42);
    doc.text("DATA: " + dataAtual, 140, 42);
    doc.line(20, 45, 190, 45);

    // DADOS DO CLIENTE
    doc.setFontSize(11); doc.text("DADOS DO CLIENTE", 20, 52);
    doc.setFont("helvetica", "normal"); doc.setFontSize(10);
    doc.text("Razao Social: " + document.getElementById('razaoCli').value, 20, 58);
    doc.text("CNPJ: " + document.getElementById('cnpjCli').value, 20, 64);

    if(tipo === 'CLIENTE') {
        const body = itens.map(i => [i.d, i.m, i.e, i.q, "R$ " + i.v.toFixed(2), "R$ " + (i.v*i.q).toFixed(2)]);
        doc.autoTable({
            startY: 70, head: [['Descricao', 'Medidas', 'Esp.', 'Qtd', 'Unit.', 'Total']], body,
            headStyles: { fillColor: [44, 123, 229] }, theme: 'grid'
        });
        const fY = doc.lastAutoTable.finalY + 10;
        doc.setFont("helvetica", "bold"); doc.text("VALOR TOTAL: " + document.getElementById('totalTxt').innerText, 190, fY, {align:'right'});
        if(document.getElementById('obs').value) {
            doc.setFont("helvetica", "normal"); doc.setFontSize(9);
            doc.text("Obs: " + document.getElementById('obs').value, 20, fY + 10);
        }
    } else {
        // PDF DE PRODUCAO (INTERNO)
        doc.setFont("helvetica", "bold"); doc.text("RELATORIO INTERNO DE PRODUCAO / COMPRAS", 105, 75, {align:'center'});
        
        const bodyProd = itens.map(i => {
            const kgCompra = (i.pesoKg * 1.2).toFixed(2); // +20%
            const custoTotal = (kgCompra * i.custoBorracha).toFixed(2);
            return [i.material, i.m, i.pesoKg + "kg", kgCompra + "kg", "R$ " + i.custoBorracha, "R$ " + custoTotal];
        });

        doc.autoTable({
            startY: 85, 
            head: [['Materia-Prima', 'Medidas', 'Peso Liq.', 'Comprar (+20%)', 'Custo KG', 'Custo Total']], 
            body: bodyProd,
            headStyles: { fillColor: [51, 51, 51] }, theme: 'grid'
        });
        
        const fYp = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(9); doc.text("* Este documento e para uso interno. Nao enviar ao cliente.", 20, fYp);
    }

    if(tipo === 'CLIENTE') { DB.os++; salvar(); document.getElementById('numOS').value = DB.os; }
    doc.save(tipo + "_OS_" + (DB.os - (tipo === 'CLIENTE' ? 1 : 0)) + ".pdf");
  }
</script>
</body>
</html>