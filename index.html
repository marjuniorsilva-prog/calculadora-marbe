<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sistema Marbe v18.0 - Estavel</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --primary: #2c7be5; --success: #28a745; --danger: #d9534f; --dark: #333; }
    body { font-family: sans-serif; background: #f4f7f6; margin: 0; padding: 5px; }
    .container { max-width: 1000px; background: #fff; padding: 15px; border-radius: 8px; margin: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .tabs { display: flex; gap: 3px; margin-bottom: 15px; flex-wrap: wrap; }
    .tab-btn { flex: 1; padding: 10px 5px; border: none; background: #ddd; cursor: pointer; font-weight: bold; border-radius: 5px; font-size: 10px; text-transform: uppercase; min-width: 75px; }
    .tab-btn.active { background: var(--primary); color: white; }
    .section { display: none; }
    .section.active { display: block; }
    label { display: block; margin-top: 10px; font-weight: bold; font-size: 12px; }
    input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; box-sizing: border-box; }
    .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; color: white; }
    .card { border: 1px solid #ddd; padding: 12px; border-radius: 8px; margin-bottom: 8px; background: #fafafa; }
    .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px; }
    .dash-card { background: #fff; padding: 15px; border-radius: 8px; border-left: 5px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
    table th, table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
  </style>
</head>
<body onload="init()">

<div class="container">
  <div class="tabs">
    <button class="tab-btn active" onclick="tab('calc')">Calculo</button>
    <button class="tab-btn" onclick="tab('orc')">Orcam.</button>
    <button class="tab-btn" onclick="tab('hist')">Historico</button>
    <button class="tab-btn" onclick="tab('dash')">Dashboard</button>
    <button class="tab-btn" onclick="tab('cfg')">Precos Custo</button>
  </div>

  <div id="calc" class="section active">
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
      <div><label>Diametro (mm)</label><input type="number" id="d"></div>
      <div><label>Comprimento (mm)</label><input type="number" id="l"></div>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
      <div><label>Camada (mm)</label><input type="number" id="e"></div>
      <div><label>Horas</label><input type="number" id="h" value="10"></div>
    </div>
    <label>Material</label><select id="matSelect"></select>
    <label>Servico</label>
    <select id="tipoServ"><option value="0.045">PECA NOVA</option><option value="0.065">REFORMA</option></select>
    <button class="btn" style="background:var(--success)" onclick="calcular()">CALCULAR</button>
    <div id="resCalc" style="display:none; padding:10px; background:#eef9f0; margin-top:10px; border-radius:8px; text-align:center;"></div>
    <button id="addBtn" class="btn" style="background:var(--primary); display:none;" onclick="addCarrinho()">ADICIONAR AO PEDIDO</button>
  </div>

  <div id="orc" class="section">
    <div style="display:grid; grid-template-columns: 80px 1fr; gap:10px;">
      <div><label>OS</label><input type="number" id="numOS" readonly></div>
      <div><label>CNPJ</label><input type="text" id="cnpj" onblur="buscaCNPJ(this.value)"></div>
    </div>
    <label>Razao Social Cliente</label><input type="text" id="razao">
    <div id="itensOrc" style="margin-top:10px"></div>
    <h3 style="text-align:right">Total: <span id="totalOrc">R$ 0,00</span></h3>
    <button class="btn" style="background:var(--danger)" onclick="gerarPDF('CLIENTE')">GERAR PDF CLIENTE</button>
  </div>

  <div id="hist" class="section">
    <h3>Vendas Registradas</h3>
    <div id="listaHist"></div>
  </div>

  <div id="dash" class="section">
    <h3>Relatorio de Materiais Vendidos</h3>
    <div class="dash-grid">
      <div class="dash-card"><h4>Faturamento</h4><p id="dFat">R$ 0,00</p></div>
      <div class="dash-card"><h4>Total KG</h4><p id="dKg">0 kg</p></div>
    </div>
    <div class="card">
      <strong>Necessidade de Compra (Baseado em Vendas Confirmadas)</strong>
      <table id="tabMateriaisDash">
        <thead><tr><th>Borracha</th><th>Peso Vendido (KG)</th><th>Custo Total</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="cfg" class="section">
    <h3>Tabela de Materiais (Preco de Custo)</h3>
    <label>Valor Hora Producao (R$)</label><input type="number" id="cfgVh" onchange="salvar()">
    <div id="listaMatsCfg"></div>
    <button class="btn" style="background:var(--primary)" onclick="addMat()">+ Novo Material na Tabela</button>
  </div>
</div>

<script>
  // Inicialização com proteção de dados
  let DB = { vh: 50, os: 330, mats: [{n:"Natural Preta", p:13}, {n:"Nitrilica", p:49}], vendas: [] };
  let carrinho = []; let tItem = null;

  function init() {
    let s = localStorage.getItem('marbe_v18_final');
    if(s) DB = JSON.parse(s);
    document.getElementById('numOS').value = DB.os;
    renderCfg();
  }

  function tab(id) {
    document.querySelectorAll('.section, .tab-btn').forEach(e => e.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    event.currentTarget.classList.add('active');
    if(id === 'hist') renderHist();
    if(id === 'dash') renderDash();
  }

  // --- CALCULADORA ---
  function calcular() {
    const d = parseFloat(document.getElementById('d').value);
    const l = parseFloat(document.getElementById('l').value);
    const e = parseFloat(document.getElementById('e').value);
    const pk = parseFloat(document.getElementById('matSelect').value);
    const h = parseFloat(document.getElementById('h').value);
    const imp = parseFloat(document.getElementById('tipoServ').value);
    
    if(!d || !l || !e) return alert("Preencha as medidas!");

    const peso = Math.ceil((Math.PI * (d + e) * l * e) * 1200 / 1000000000);
    const unit = (((peso * pk * 1.1) + (h * DB.vh)) * 2.5) * (1 + imp);

    tItem = { 
        n: document.getElementById('matSelect').options[document.getElementById('matSelect').selectedIndex].text,
        med: d+"x"+l, e: e+"mm", q: 1, v: unit, kg: peso, custoK: pk 
    };
    document.getElementById('resCalc').style.display="block";
    document.getElementById('resCalc').innerHTML = `Unitario: R$ ${unit.toFixed(2)} | Peso: ${peso}kg`;
    document.getElementById('addBtn').style.display="block";
  }

  function addCarrinho() { carrinho.push({...tItem}); renderCarrinho(); tab('orc'); }

  function renderCarrinho() {
    let tot = 0;
    document.getElementById('itensOrc').innerHTML = carrinho.map((i, idx) => {
        tot += i.v * i.q;
        return `<div class="card">${i.n} (${i.med}) - Qtd: ${i.q} <button onclick="carrinho.splice(${idx},1); renderCarrinho()">X</button></div>`;
    }).join('');
    document.getElementById('totalOrc').innerText = "R$ " + tot.toFixed(2);
  }

  // --- HISTÓRICO ---
  function renderHist() {
    document.getElementById('listaHist').innerHTML = DB.vendas.slice().reverse().map((v, i) => {
        const idx = DB.vendas.length - 1 - i;
        return `<div class="card">
            OS: ${v.os} | ${v.cliente} | R$ ${v.total.toFixed(2)}<br>
            ${!v.confirmada ? `<button onclick="confirmar(${idx})" style="background:var(--success); color:white; border:none; padding:5px; border-radius:4px; margin-top:5px;">Confirmar Venda</button>` : `<b style="color:green">VENDA CONFIRMADA</b>`}
        </div>`;
    }).join('');
  }

  function confirmar(i) { DB.vendas[i].confirmada = true; salvar(); renderHist(); }

  // --- DASHBOARD ---
  function renderDash() {
    let fat = 0, kgTotal = 0;
    let resumo = {};

    DB.vendas.filter(v => v.confirmada).forEach(v => {
      fat += v.total;
      v.itens.forEach(it => {
        let pesoItem = it.kg * it.q;
        kgTotal += pesoItem;
        if(!resumo[it.n]) resumo[it.n] = { kg: 0, custo: 0 };
        resumo[it.n].kg += pesoItem;
        resumo[it.n].custo += (pesoItem * it.custoK);
      });
    });

    document.getElementById('dFat').innerText = "R$ " + fat.toFixed(2);
    document.getElementById('dKg').innerText = kgTotal.toFixed(1) + " kg";
    const tbody = document.querySelector('#tabMateriaisDash tbody');
    tbody.innerHTML = Object.keys(resumo).map(m => `<tr><td>${m}</td><td>${resumo[m].kg.toFixed(1)} kg</td><td>R$ ${resumo[m].custo.toFixed(2)}</td></tr>`).join('');
  }

  // --- PDF ---
  function gerarPDF(tipo) {
    const { jsPDF } = window.jspdf; const doc = new jsPDF();
    const os = DB.os;
    doc.setFont("helvetica", "bold"); doc.text("S B COMERCIO DE BORRACHAS E SERVICOS LTDA", 20, 20);
    doc.setFontSize(9); doc.setFont("helvetica", "normal");
    doc.text("CNPJ: 61.149.312/0001-56", 20, 26);
    doc.text("OS: "+os+" | Cliente: "+document.getElementById('razao').value, 20, 32);
    const rows = carrinho.map(i => [i.n, i.med, i.e, i.q, i.v.toFixed(2), (i.v*i.q).toFixed(2)]);
    doc.autoTable({ startY: 40, head: [['Descricao', 'Medida', 'Esp', 'Qtd', 'Unit', 'Total']], body: rows });
    
    DB.vendas.push({ os, cliente: document.getElementById('razao').value, total: parseFloat(document.getElementById('totalOrc').innerText.replace("R$ ","")), confirmada: false, itens: [...carrinho] });
    DB.os++; salvar(); doc.save("OS_"+os+".pdf");
  }

  // --- CONFIG (MATERIAIS E PREÇOS) ---
  function renderCfg() {
    document.getElementById('cfgVh').value = DB.vh;
    document.getElementById('matSelect').innerHTML = DB.mats.map(m => `<option value="${m.p}">${m.n}</option>`).join('');
    document.getElementById('listaMatsCfg').innerHTML = DB.mats.map((m, i) => `
        <div style="display:flex; gap:5px; margin-top:5px">
            <input type="text" value="${m.n}" readonly style="flex:2">
            <input type="number" value="${m.p}" onchange="DB.mats[${i}].p=parseFloat(this.value); salvar()">
            <button onclick="DB.mats.splice(${i},1); salvar(); renderCfg()">X</button>
        </div>`).join('');
  }

  function addMat() {
    const n = prompt("Nome do Material:"); const p = prompt("Preco de Custo por KG:");
    if(n && p) { DB.mats.push({n, p: parseFloat(p)}); salvar(); renderCfg(); }
  }

  function salvar() { 
    DB.vh = parseFloat(document.getElementById('cfgVh').value);
    localStorage.setItem('marbe_v18_final', JSON.stringify(DB)); 
  }

  async function buscaCNPJ(v) {
    const r = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${v.replace(/\D/g,'')}`);
    const d = await r.json(); document.getElementById('razao').value = d.razao_social || "";
  }
</script>
</body>
</html>