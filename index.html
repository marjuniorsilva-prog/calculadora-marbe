<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sistema Marbe v31.31 - Versão Total</title>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyATu_V6e1shKRpgBOkX1lw2beyzUEZUCo0",
      authDomain: "marbeapp-e2db8.firebaseapp.com",
      projectId: "marbeapp-e2db8",
      storageBucket: "marbeapp-e2db8.firebasestorage.app",
      messagingSenderId: "435226749841",
      appId: "1:435226749841:web:c2b5f5dee676412b228830",
      measurementId: "G-7E0M9SL1DK"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    window.marbeDB = { os: 330, orçamentos: [], pedidos: [], financeiro: [], custos: {vh: 50, mats: []}, estoque: {} };

    onValue(ref(db, 'sistema/'), (snapshot) => {
      const data = snapshot.val();
      if (data) { 
          window.marbeDB = data; 
          if(!window.marbeDB.estoque) window.marbeDB.estoque = {};
          if(!window.marbeDB.orçamentos) window.marbeDB.orçamentos = [];
          if(!window.marbeDB.pedidos) window.marbeDB.pedidos = [];
          if(!window.marbeDB.financeiro) window.marbeDB.financeiro = [];
          updateUI(); 
      }
    });

    window.salvarNuvem = function() { set(ref(db, 'sistema/'), window.marbeDB); };

    window.baixarPDF = (blob, osNum) => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `${osNum}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    };
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    :root { --primary: #2c7be5; --success: #28a745; --danger: #d9534f; --info: #17a2b8; --dark: #333; }
    body { font-family: sans-serif; background: #f4f7f6; margin: 0; padding: 5px; }
    .container { max-width: 1000px; background: #fff; padding: 15px; border-radius: 8px; margin: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .tabs { display: flex; gap: 3px; margin-bottom: 15px; flex-wrap: wrap; }
    .tab-btn { flex: 1; padding: 10px; border: none; background: #ddd; cursor: pointer; font-weight: bold; border-radius: 8px; font-size: 9px; text-transform: uppercase; min-width: 75px; }
    .tab-btn.active { background: var(--primary); color: white; }
    .section { display: none; }
    .section.active { display: block; }
    label { display: block; margin-top: 10px; font-weight: bold; font-size: 11px; }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; box-sizing: border-box; }
    .btn { width: 100%; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 8px; color: white; text-align: center; display: block; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; }
    table th, table td { border: 1px solid #ddd; padding: 6px; text-align: left; }
    .card-list { background: #fff; border: 1px solid #ddd; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #ccc; }
    .editable-input { width: 100%; border: 1px solid #ffd666 !important; background: #fffbe6; padding: 4px; }
    .negativo { color: var(--danger); font-weight: bold; }
    .positivo { color: var(--success); font-weight: bold; }
  </style>
</head>
<body>

<div class="container">
  <div class="tabs">
    <button class="tab-btn active" onclick="tab('calc')">Cálculo</button>
    <button class="tab-btn" onclick="tab('orc')">Orçamento</button>
    <button class="tab-btn" onclick="tab('historico')">Histórico</button>
    <button class="tab-btn" onclick="tab('suprimentos')" style="background:var(--info); color:white;">Suprimentos</button>
    <button class="tab-btn" onclick="tab('pedidos')" style="background:var(--dark); color:white;">Pedidos/NF</button>
    <button class="tab-btn" onclick="tab('financeiro')" style="background:var(--success); color:white;">Boletos</button>
    <button class="tab-btn" onclick="tab('cfg')">Custos</button>
  </div>

  <div id="calc" class="section active">
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
      <div><label>Diâmetro (mm)</label><input type="number" id="d"></div>
      <div><label>Comprimento (mm)</label><input type="number" id="l"></div>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
      <div><label>Camada (mm)</label><input type="number" id="e"></div>
      <div><label>Horas Trab.</label><input type="number" id="h" value="10"></div>
    </div>
    <label>Material</label><select id="matSelect"></select>
    <label>Tipo</label><select id="tipoServ"><option value="0.045">PEÇA NOVA</option><option value="0.065">REFORMA</option></select>
    <button class="btn" style="background:var(--success)" onclick="calcular()">CALCULAR E ADICIONAR</button>
  </div>

  <div id="orc" class="section">
    <label>OS em Edição: <strong id="osEdicaoLabel">Nova</strong></label>
    <label>CNPJ Cliente</label><input type="text" id="cnpj" onblur="buscaCNPJ(this.value)">
    <label>Razão Social</label><input type="text" id="razao">
    <label>Endereço Completo</label><input type="text" id="endereco">
    
    <table>
        <thead><tr><th>Descrição</th><th>Medidas</th><th>Cam.</th><th>Qtd</th><th>Unit.</th><th>X</th></tr></thead>
        <tbody id="corpoAtual"></tbody>
    </table>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div><label>Frete</label><select id="frete"><option>POR CONTA DO CLIENTE</option><option>POR CONTA DA EMPRESA</option></select></div>
        <div><label>Prazo Entrega</label><input type="text" id="prazo" value="10 DIAS ÚTEIS"></div>
    </div>
    <label>Forma de Pagamento</label><textarea id="pagamento">50% + BOLETO 28DD.</textarea>
    
    <h3 style="text-align:right">Total: <span id="totalOrc">R$ 0,00</span></h3>
    <button class="btn" style="background:var(--primary)" onclick="salvarOrcamento()">SALVAR PEDIDO / ORÇAMENTO</button>
    <button id="btnCancelaEdit" class="btn" style="background:var(--danger); display:none;" onclick="cancelarEdicao()">CANCELAR EDIÇÃO</button>
  </div>

  <div id="historico" class="section"><div id="listaOrcamentos"></div></div>
  <div id="pedidos" class="section"><div id="listaPedidos"></div></div>
  <div id="financeiro" class="section"><div id="listaBoletos"></div></div>
  
  <div id="suprimentos" class="section">
      <h3>Estoque Necessário (Pedidos em Aberto)</h3>
      <div id="dashboardSuprimentos"></div>
  </div>

  <div id="cfg" class="section"><div id="listaCustos"></div>
    <div style="background:#eee; padding:10px; border-radius:8px; margin-top:10px;">
        <input type="text" id="matNome" placeholder="Material"><input type="number" id="matPreco" placeholder="Preço KG">
        <button class="btn" style="background:var(--success)" onclick="addMaterial()">CADASTRAR MATERIAL</button>
    </div>
  </div>
</div>

<script>
  let itensTemp = [];
  let idEdicao = null;

  function tab(id) {
    document.querySelectorAll('.section, .tab-btn').forEach(e => e.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(id === 'suprimentos') renderSuprimentos();
  }

  function updateUI() {
    document.getElementById('matSelect').innerHTML = (window.marbeDB.custos.mats || []).map(m => `<option value="${m.p}">${m.n}</option>`).join('');
    renderOrcamentos(); renderPedidos(); renderBoletos(); renderCustos();
  }

  async function buscaCNPJ(v) {
    const cnpj = v.replace(/\D/g, ''); if (cnpj.length !== 14) return;
    try {
      const r = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`);
      const d = await r.json();
      document.getElementById('razao').value = d.razao_social || "";
      document.getElementById('endereco').value = d.logradouro ? `${d.logradouro}, ${d.numero} - ${d.bairro}, ${d.municipio} - ${d.uf}` : "";
    } catch (e) {}
  }

  function calcular() {
    const d=parseFloat(document.getElementById('d').value), l=parseFloat(document.getElementById('l').value), e=parseFloat(document.getElementById('e').value), pk=parseFloat(document.getElementById('matSelect').value), h=parseFloat(document.getElementById('h').value), matNome = document.getElementById('matSelect').options[document.getElementById('matSelect').selectedIndex].text;
    const pesoUnit = Math.ceil((Math.PI*(d+e)*l*e)*1200/1000000000);
    const unit = (((pesoUnit*pk*1.1)+(h*window.marbeDB.custos.vh))*2.5)*(1+(parseFloat(document.getElementById('tipoServ').value)));
    itensTemp.push({ n: "Revestimento " + matNome, mat: matNome, med: d + "x" + l + "mm", e: e + "mm", q: 1, v: unit, kg_unit: pesoUnit });
    renderTabelaAtual(); tab('orc');
  }

  function renderTabelaAtual() {
    let total = 0;
    document.getElementById('corpoAtual').innerHTML = itensTemp.map((it, i) => {
        total += it.v * it.q;
        return `<tr>
            <td><input type="text" class="editable-input" value="${it.n}" onchange="itensTemp[${i}].n=this.value"></td>
            <td><input type="text" class="editable-input" value="${it.med}" onchange="itensTemp[${i}].med=this.value"></td>
            <td><input type="text" class="editable-input" value="${it.e}" onchange="itensTemp[${i}].e=this.value"></td>
            <td><input type="number" class="editable-input" value="${it.q}" onchange="itensTemp[${i}].q=parseInt(this.value); renderTabelaAtual()"></td>
            <td><input type="number" class="editable-input" value="${it.v.toFixed(2)}" onchange="itensTemp[${i}].v=parseFloat(this.value); renderTabelaAtual()"></td>
            <td onclick="itensTemp.splice(${i},1);renderTabelaAtual()">X</td></tr>`;
    }).join('');
    document.getElementById('totalOrc').innerText = "R$ " + total.toFixed(2);
  }

  function salvarOrcamento() {
    const orcData = { os: idEdicao ? idEdicao.os : window.marbeDB.os, cliente: document.getElementById('razao').value, cnpj: document.getElementById('cnpj').value, endereco: document.getElementById('endereco').value, itens: JSON.parse(JSON.stringify(itensTemp)), frete: document.getElementById('frete').value, prazo: document.getElementById('prazo').value, pagamento: document.getElementById('pagamento').value, total: itensTemp.reduce((a,b)=>a+(b.v*b.q),0) };
    if(idEdicao) {
        if(idEdicao.origem === 'pedidos') window.marbeDB.pedidos[idEdicao.index] = orcData;
        else window.marbeDB.orçamentos[idEdicao.index] = orcData;
        idEdicao = null; document.getElementById('btnCancelaEdit').style.display = 'none'; document.getElementById('osEdicaoLabel').innerText = "Nova";
    } else {
        window.marbeDB.orçamentos.push(orcData); window.marbeDB.os++;
    }
    window.salvarNuvem(); itensTemp = []; renderTabelaAtual(); tab('historico');
  }

  function renderOrcamentos() {
    document.getElementById('listaOrcamentos').innerHTML = (window.marbeDB.orçamentos || []).map((o, i) => `
      <div class="card-list">
        <strong>OS: ${o.os} - ${o.cliente}</strong><br>
        <button class="btn" style="background:var(--info); display:inline-block; width:31%" onclick="gerarPDF('CLIENTE', ${i}, 'orçamentos')">PDF</button>
        <button class="btn" style="background:var(--dark); display:inline-block; width:31%" onclick="editarExistente('orçamentos', ${i})">EDITAR</button>
        <button class="btn" style="background:var(--success); display:inline-block; width:31%" onclick="fecharPedido(${i})">FECHAR</button>
      </div>`).join('');
  }

  function fecharPedido(i) {
    const orc = window.marbeDB.orçamentos.splice(i, 1)[0];
    window.marbeDB.pedidos.push(orc); window.salvarNuvem(); tab('suprimentos');
  }

  function renderSuprimentos() {
    const necessidade = {};
    (window.marbeDB.pedidos || []).forEach(p => p.itens.forEach(it => {
        const mat = it.mat || "Outros"; necessidade[mat] = (necessidade[mat] || 0) + (it.kg_unit * 1.2 * it.q);
    }));
    let html = `<table><thead><tr><th>Material</th><th>Necessário</th><th>Estoque</th><th>Saldo</th></tr></thead><tbody>`;
    Object.keys(necessidade).forEach(mat => {
        const prec = necessidade[mat], comp = window.marbeDB.estoque[mat] || 0, saldo = comp - prec;
        html += `<tr><td>${mat}</td><td>${prec.toFixed(2)}kg</td><td><input type="number" value="${comp}" onchange="atualizarEstoque('${mat}', this.value)" style="width:60px"></td><td class="${saldo < 0 ? 'negativo' : 'positivo'}">${saldo < 0 ? 'Falta ' + Math.abs(saldo).toFixed(2) : 'OK'}</td></tr>`;
    });
    document.getElementById('dashboardSuprimentos').innerHTML = Object.keys(necessidade).length ? html + "</tbody></table>" : "<p>Sem pedidos pendentes.</p>";
  }

  window.atualizarEstoque = function(m, v) { window.marbeDB.estoque[m] = parseFloat(v); window.salvarNuvem(); renderSuprimentos(); };

  function renderPedidos() {
    document.getElementById('listaPedidos').innerHTML = (window.marbeDB.pedidos || []).map((p, i) => `
      <div class="card-list">
        <strong>OS: ${p.os} - ${p.cliente}</strong><br>
        <button class="btn" style="background:var(--info); width:48%; display:inline-block" onclick="editarExistente('pedidos', ${i})">EDITAR/DESC.</button>
        <button class="btn" style="background:var(--dark); width:48%; display:inline-block" onclick="gerarPDF('PRODUCAO', ${i}, 'pedidos')">PRODUÇÃO</button>
        <input type="text" id="nf_${i}" placeholder="NF" style="margin-top:5px"><input type="number" id="parc_${i}" placeholder="Parc."><input type="date" id="data_${i}">
        <button class="btn" style="background:var(--success)" onclick="faturar(${i})">FATURAR</button>
      </div>`).join('');
  }

  function gerarPDF(tipo, index, base) {
    const { jsPDF } = window.jspdf; const doc = new jsPDF(); const d = window.marbeDB[base][index];
    const clean = (t) => t ? t.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase() : "";
    doc.setFontSize(11); doc.text("S B COMERCIO DE BORRACHAS E SERVICOS LTDA", 20, 15);
    doc.setFontSize(9); doc.text(`OS: ${d.os} | DATA: ${new Date().toLocaleDateString('pt-BR')}`, 20, 22);
    if(tipo === 'PRODUCAO') {
        doc.autoTable({ startY: 28, head: [['ITEM', 'MEDIDAS', 'QTD', 'PESO BRUTO']], body: d.itens.map(i => [clean(i.n), i.med, i.q, (i.kg_unit * 1.2 * i.q).toFixed(2) + " KG"]) });
    } else {
        doc.text(`CLIENTE: ${clean(d.cliente)} | CNPJ: ${d.cnpj || ""}`, 20, 28);
        doc.text(`ENDERECO: ${clean(d.endereco)}`, 20, 33);
        doc.autoTable({ startY: 38, head: [['DESCRICAO', 'MEDIDAS', 'QTD', 'TOTAL']], body: d.itens.map(i => [clean(i.n), i.med, i.q, (i.v*i.q).toFixed(2)]) });
        doc.text(`TOTAL: R$ ${d.total.toFixed(2)}`, 190, doc.lastAutoTable.finalY + 10, {align:'right'});
    }
    window.baixarPDF(doc.output('blob'), d.os);
  }

  function faturar(i) {
    const nf = document.getElementById(`nf_${i}`).value, qtd = parseInt(document.getElementById(`parc_${i}`).value), dt = document.getElementById(`data_${i}`).value;
    if(!nf || !qtd || !dt) return alert("Erro");
    const p = window.marbeDB.pedidos[i]; const dataBase = new Date(dt + "T12:00:00");
    for(let j=0; j<qtd; j++) {
        let v = new Date(dataBase); v.setMonth(v.getMonth() + j);
        window.marbeDB.financeiro.push({ os: p.os, nf: nf, cliente: p.cliente, valor: p.total/qtd, venc: v.toLocaleDateString('pt-BR'), pago: false });
    }
    window.marbeDB.pedidos.splice(i, 1); window.salvarNuvem(); tab('financeiro');
  }

  function renderBoletos() {
    document.getElementById('listaBoletos').innerHTML = (window.marbeDB.financeiro || []).map((f, i) => `<div class="card-list">${f.cliente} | OS: ${f.os} | R$ ${f.valor.toFixed(2)} | Venc: ${f.venc} <button onclick="window.marbeDB.financeiro[${i}].pago=true; window.salvarNuvem();" style="float:right">OK</button></div>`).join('');
  }

  function editarExistente(origem, index) {
      const base = window.marbeDB[origem][index]; idEdicao = { origem, index, os: base.os };
      document.getElementById('cnpj').value = base.cnpj || ""; document.getElementById('razao').value = base.cliente;
      document.getElementById('endereco').value = base.endereco || ""; document.getElementById('osEdicaoLabel').innerText = base.os;
      document.getElementById('btnCancelaEdit').style.display = 'block'; itensTemp = JSON.parse(JSON.stringify(base.itens));
      renderTabelaAtual(); tab('orc');
  }

  function renderCustos() {
    document.getElementById('listaCustos').innerHTML = (window.marbeDB.custos.mats || []).map((m, i) => `<div style="display:flex; gap:5px;"><input value="${m.n}" readonly style="flex:2"><input value="${m.p}" readonly style="flex:1"><button onclick="window.marbeDB.custos.mats.splice(${i},1); window.salvarNuvem()" style="background:red; color:white; border:none; padding:5px;">X</button></div>`).join('');
  }

  function addMaterial() {
    const n = document.getElementById('matNome').value, p = parseFloat(document.getElementById('matPreco').value);
    if(n && p) { window.marbeDB.custos.mats.push({n, p}); window.salvarNuvem(); document.getElementById('matNome').value=""; document.getElementById('matPreco').value=""; }
  }
</script>
</body>
</html>
