<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sistema v33.4 (Final)</title>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyATu_V6e1shKRpgBOkX1lw2beyzUEZUCo0",
      authDomain: "marbeapp-e2db8.firebaseapp.com",
      projectId: "marbeapp-e2db8",
      storageBucket: "marbeapp-e2db8.firebasestorage.app",
      messagingSenderId: "435226749841",
      appId: "1:435226749841:web:c2b5f5dee676412b228830",
      measurementId: "G-7E0M9SL1DK"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    window.marbeDB = { os: 330, orçamentos: [], pedidos: [], financeiro: [], custos: {vh: 50, mats: []}, estoque: {} };

    onValue(ref(db, 'sistema/'), (snapshot) => {
      const data = snapshot.val();
      if (data) { 
          window.marbeDB = data; 
          updateUI(); 
      }
    });

    window.salvarNuvem = function() { 
        set(ref(db, 'sistema/'), window.marbeDB)
            .then(() => { console.log("Salvo com sucesso!"); })
            .catch((error) => { alert("Erro ao salvar: " + error.message); });
    };

    window.abrirPDFMobile = (blob, osNum) => {
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
        const a = document.createElement('a');
        a.href = url; a.download = `${osNum}.pdf`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    };

    window.fmtMoney = (v) => {
        return parseFloat(v).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    :root { --primary: #2c7be5; --success: #28a745; --danger: #d9534f; --info: #17a2b8; --dark: #333; --prod: #6f42c1; --warning: #ffc107; }
    body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; padding: 5px; color: #333; }
    
    #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
    .login-box { width: 100%; max-width: 350px; text-align: center; }
    .login-logo { max-width: 100%; height: auto; margin-bottom: 30px; }
    .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
    .login-btn { width: 100%; padding: 12px; background: #002B49; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; }

    .container { max-width: 1000px; background: #fff; padding: 15px; border-radius: 8px; margin: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; }
    .tabs { display: flex; gap: 4px; margin-bottom: 15px; flex-wrap: wrap; }
    .tab-btn { flex: 1; padding: 10px; border: none; background: #e9ecef; cursor: pointer; font-weight: bold; border-radius: 6px; font-size: 10px; text-transform: uppercase; min-width: 70px; transition: 0.2s; }
    .tab-btn.active { background: var(--primary); color: white; }
    .section { display: none; animation: fadeIn 0.3s; }
    .section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    label { display: block; margin-top: 10px; font-weight: 600; font-size: 11px; color: #555; }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; box-sizing: border-box; }
    .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; color: white; text-align: center; display: block; font-size: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    
    table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; }
    table th { background: #f8f9fa; border: 1px solid #dee2e6; padding: 8px; text-align: left; }
    table td { border: 1px solid #dee2e6; padding: 8px; }
    .card-list { background: #fff; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #ccc; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .editable-input { width: 100%; border: 1px solid #ffd666 !important; background: #fffbe6; padding: 4px; }
    .negativo { color: var(--danger); font-weight: bold; }
    .positivo { color: var(--success); font-weight: bold; }

    /* ESTILOS CALCULADORA */
    .hidden { display: none !important; }
    .row { display: flex; gap: 10px; }
    .col { flex: 1; }
    .resultado-box { background: #2c3e50; color: #fff; padding: 15px; border-radius: 6px; margin-top: 15px; font-size: 12px; }
    .res-line { display: flex; justify-content: space-between; border-bottom: 1px solid #455a64; padding: 4px 0; }
    .res-destaque { font-size: 16px; font-weight: bold; color: #2ecc71; text-align: center; margin-top: 10px; padding-top: 5px; border-top: 1px solid #fff; }
    details { background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #dee2e6; margin-top: 10px; }
    summary { font-weight: bold; cursor: pointer; font-size: 11px; color: #666; }
  </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <img src="logo.jpg" alt="Logo Grupo Marbe" class="login-logo">
        <input type="text" id="loginUser" class="login-input" placeholder="Usuário">
        <input type="password" id="loginPass" class="login-input" placeholder="Senha">
        <button class="login-btn" onclick="fazerLogin()">ENTRAR</button>
        <p style="font-size:12px; color:#888; margin-top:15px">Sistema v33.4</p>
    </div>
</div>

<div class="container" id="appContainer">
  <div class="tabs">
    <button class="tab-btn active" onclick="tab('calc')">Cálculo</button>
    <button class="tab-btn" onclick="tab('orc')">Orçamento</button>
    <button class="tab-btn" onclick="tab('historico')">Histórico</button>
    <button class="tab-btn" onclick="tab('suprimentos')" style="background:var(--info); color:white;">Suprimentos</button>
    <button class="tab-btn" onclick="tab('pedidos')" style="background:var(--dark); color:white;">Pedidos/NF</button>
    <button class="tab-btn" onclick="tab('financeiro')" style="background:var(--success); color:white;">Boletos</button>
    <button class="tab-btn" onclick="tab('cfg')">Custos</button>
  </div>

  <div id="calc" class="section active">
    
    <label>Geometria da Peça</label>
    <select id="tipoPeca" onchange="mudarInputsCalculo()">
        <option value="retangular">Retangular / Placa (C x L x E)</option>
        <option value="quadrada">Quadrada (Lado x E)</option>
        <option value="redonda">Redonda Maciça (Disco/Cilindro)</option>
        <option value="tubo">Tubo / Bucha (Furo no meio)</option>
        <option value="oring">Anel O-Ring</option>
        <option value="esfera">Esfera / Bola</option>
        <option value="cone">Cone / Batente</option>
        <option value="peso_direto">★ JÁ SEI O PESO (Modo Direto)</option>
        <option value="revestimento">Revestimento (Rolo/Cilindro)</option>
    </select>

    <div id="area-inputs" style="background: #f9f9f9; padding: 10px; border-radius: 5px; border:1px solid #eee;">
        <div id="input-retangular" class="grupo-input">
            <div class="row">
                <div class="col"><label>Comp. (mm)</label><input type="number" id="ret-comp"></div>
                <div class="col"><label>Largura (mm)</label><input type="number" id="ret-larg"></div>
            </div>
            <label>Espessura (mm)</label><input type="number" id="ret-esp">
        </div>

        <div id="input-quadrada" class="grupo-input hidden">
            <div class="row">
                <div class="col"><label>Lado (mm)</label><input type="number" id="quad-lado"></div>
                <div class="col"><label>Espessura (mm)</label><input type="number" id="quad-esp"></div>
            </div>
        </div>

        <div id="input-redonda" class="grupo-input hidden">
            <div class="row">
                <div class="col"><label>Diâmetro (mm)</label><input type="number" id="red-diam"></div>
                <div class="col"><label>Alt/Esp (mm)</label><input type="number" id="red-esp"></div>
            </div>
        </div>

        <div id="input-tubo" class="grupo-input hidden">
            <div class="row">
                <div class="col"><label>Ø Externo</label><input type="number" id="tubo-ext"></div>
                <div class="col"><label>Ø Interno</label><input type="number" id="tubo-int"></div>
            </div>
            <label>Comprimento (mm)</label><input type="number" id="tubo-comp">
        </div>

        <div id="input-oring" class="grupo-input hidden">
            <div class="row">
                <div class="col"><label>Ø Interno</label><input type="number" id="oring-di"></div>
                <div class="col"><label>Esp. Fio</label><input type="number" id="oring-fio"></div>
            </div>
        </div>

        <div id="input-esfera" class="grupo-input hidden">
            <label>Diâmetro da Esfera (mm)</label><input type="number" id="esf-diam">
        </div>

        <div id="input-cone" class="grupo-input hidden">
            <div class="row">
                <div class="col"><label>Ø Maior</label><input type="number" id="cone-maior"></div>
                <div class="col"><label>Ø Menor</label><input type="number" id="cone-menor"></div>
            </div>
            <label>Altura (mm)</label><input type="number" id="cone-alt">
        </div>

        <div id="input-peso_direto" class="grupo-input hidden">
            <label style="color:var(--primary)">Peso da Peça (em GRAMAS)</label>
            <input type="number" id="peso-input" placeholder="Ex: 250">
        </div>

        <div id="input-revestimento" class="grupo-input hidden">
            <div class="row">
                <div class="col"><label>Diâmetro (mm)</label><input type="number" id="rev-diam"></div>
                <div class="col"><label>Comprimento (mm)</label><input type="number" id="rev-comp"></div>
            </div>
            <label>Camada de Borracha (mm)</label><input type="number" id="rev-camada">
        </div>
    </div>

    <div style="margin-top:10px; border-top: 1px dashed #ccc; padding-top:10px;">
        <div class="row">
            <div class="col" id="colPecasHora">
                <label>Peças/Hora</label>
                <input type="number" id="pecasHora" value="4">
            </div>
            <div class="col hidden" id="colHorasGastas">
                <label style="color:#d35400">Horas Gastas (Total)</label>
                <input type="number" id="horasGastas" value="1" placeholder="Ex: 8">
            </div>
            
            <div class="col" id="colPerda">
                <label>% Perda (Flash)</label>
                <input type="number" id="percPerda" value="30">
            </div>
        </div>
        
        <label>Material Utilizado</label>
        <select id="matSelect"></select>

        <label style="color:var(--prod)">Tipo de Serviço (Imposto)</label>
        <select id="tipoServicoCalc" style="border-color:var(--prod); background-color:#f3e5f5; font-weight:bold;">
            <option value="4.5">PEÇA NOVA (4.5%)</option>
            <option value="6.5">REFORMA (6.5%)</option>
        </select>

        <details>
            <summary>Editar Custos & Markup</summary>
            <div class="row">
                <div class="col"><label>Markup (Venda)</label><input type="number" id="markup" value="2.5"></div>
                <div class="col"><label>Densidade</label><input type="number" id="densidade" value="1.2"></div>
            </div>
            <div class="row">
                 <div class="col"><label>Custo Hora (Global)</label><input type="number" id="custoHoraInput" disabled style="background:#eee"></div>
            </div>
        </details>
    </div>

    <button class="btn" style="background:var(--info)" onclick="simularCalculo()">SIMULAR CUSTO</button>

    <div id="boxResultado" class="resultado-box hidden">
        <div class="res-line"><span>Item:</span> <span id="resDesc">...</span></div>
        <div class="res-line"><span>Peso Líquido:</span> <span id="resPesoLiq">0g</span></div>
        <div class="res-line" style="color:#f1c40f"><span id="lblPesoBruto">Peso Bruto:</span> <span id="resPesoBruto">0g</span></div>
        <hr style="border-color:#455a64">
        
        <div class="res-line"><span>Custo Matéria:</span> <span id="resCustoMat">R$ 0,00</span></div>
        <div class="res-line" id="linhaCola"><span>Custo Cola (10%):</span> <span id="resCustoCola">R$ 0,00</span></div>
        <div class="res-line"><span>Custo Mão de Obra:</span> <span id="resCustoMO">R$ 0,00</span></div>
        <div class="res-line" style="font-weight:bold"><span>Custo Produção:</span> <span id="resCustoTot">R$ 0,00</span></div>
        
        <div class="res-line" style="margin-top:5px; border-top:1px dashed #777; padding-top:5px;"><span>Markup Aplicado:</span> <span id="resMarkup"></span></div>
        <div class="res-line"><span>Imposto (<span id="resTaxa"></span>%):</span> <span id="resValorImposto">R$ 0,00</span></div>
        
        <div class="res-destaque" id="resPrecoVenda">R$ 0,00</div>
        
        <button class="btn" style="background:var(--success); margin-top:10px; border:1px solid white;" onclick="adicionarAoOrcamento()">ADICIONAR AO ORÇAMENTO</button>
    </div>

  </div>

  <div id="orc" class="section">
    <label>OS em Edição: <strong id="osEdicaoLabel">Nova</strong></label>
    <label>CNPJ Cliente</label><input type="text" id="cnpj" onblur="buscaCNPJ(this.value)">
    <label>Razão Social</label><input type="text" id="razao">
    <label>Endereço Completo</label><input type="text" id="endereco">
    <table><thead><tr><th>Descrição</th><th>Material</th><th>Qtd</th><th>Unit. (R$)</th><th>X</th></tr></thead><tbody id="corpoAtual"></tbody></table>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div><label>Frete</label><select id="frete"><option>POR CONTA DO CLIENTE</option><option>POR CONTA DA EMPRESA</option></select></div>
        <div><label>Prazo Entrega</label><input type="text" id="prazo" value="10 DIAS ÚTEIS"></div>
    </div>
    <label>Forma de Pagamento</label><textarea id="pagamento">50% + BOLETO 28DD.</textarea>
    <h3 style="text-align:right">Total: <span id="totalOrc">R$ 0,00</span></h3>
    <button class="btn" style="background:var(--primary)" onclick="salvarOrcamento()">SALVAR PEDIDO / ORÇAMENTO</button>
    <button id="btnCancelaEdit" class="btn" style="background:var(--danger); display:none;" onclick="cancelarEdicao()">CANCELAR EDIÇÃO</button>
  </div>

  <div id="historico" class="section"><div id="listaOrcamentos"></div></div>
  <div id="pedidos" class="section"><div id="listaPedidos"></div></div>
  <div id="financeiro" class="section"><div id="listaBoletos"></div></div>
  <div id="suprimentos" class="section"><h3>Resumo de Borracha (Necessidade)</h3><div id="dashboardSuprimentos"></div></div>
  
  <div id="cfg" class="section">
      <h3>Configurações de Custo</h3>
      <label>Valor da Hora Técnica (R$)</label>
      <input type="number" id="valorHoraGlobal" onchange="window.marbeDB.custos.vh=parseFloat(this.value); window.salvarNuvem(); updateUI();">
      
      <h3>Materiais Cadastrados</h3>
      <div id="listaCustos"></div>
      <hr>
      <label>Novo Material</label>
      <input type="text" id="matNome" placeholder="Nome (Ex: Borracha Natural)"><input type="number" id="matPreco" placeholder="Preço por KG">
      <button class="btn" style="background:var(--success)" onclick="addMaterial()">CADASTRAR MATERIAL</button>
  </div>
</div>

<script>
  let itensTemp = [];
  let idEdicao = null;
  let ultimoCalculo = null; 

  function fazerLogin() {
      const u = document.getElementById('loginUser').value;
      const p = document.getElementById('loginPass').value;
      if (u === 'Abel' && p === '201000') {
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('appContainer').style.display = 'block';
      } else {
          alert("Usuário ou senha incorretos!");
      }
  }

  function tab(id) {
    document.querySelectorAll('.section, .tab-btn').forEach(e => e.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(id === 'suprimentos') renderSuprimentos();
  }

  function updateUI() {
    const sel = document.getElementById('matSelect');
    if(sel && window.marbeDB.custos && window.marbeDB.custos.mats) {
        const currentVal = sel.value; 
        sel.innerHTML = window.marbeDB.custos.mats.map(m => `<option value="${m.p}">${m.n}</option>`).join('');
        if(currentVal) sel.value = currentVal;
    }
    if(window.marbeDB.custos) {
        document.getElementById('valorHoraGlobal').value = window.marbeDB.custos.vh || 50;
        document.getElementById('custoHoraInput').value = window.marbeDB.custos.vh || 50;
    }
    renderOrcamentos(); renderPedidos(); renderBoletos(); renderCustos();
  }

  // --- LÓGICA CALCULADORA ---
  function mudarInputsCalculo() {
      document.querySelectorAll('.grupo-input').forEach(el => el.classList.add('hidden'));
      document.getElementById('boxResultado').classList.add('hidden');
      const tipo = document.getElementById('tipoPeca').value;
      document.getElementById('input-' + tipo).classList.remove('hidden');

      if(tipo === 'revestimento') {
          document.getElementById('colPecasHora').classList.add('hidden');
          document.getElementById('colHorasGastas').classList.remove('hidden');
          // OCULTA O CAMPO DE PERDA NO MODO REVESTIMENTO
          document.getElementById('colPerda').classList.add('hidden');
      } else {
          document.getElementById('colPecasHora').classList.remove('hidden');
          document.getElementById('colHorasGastas').classList.add('hidden');
          // EXIBE O CAMPO DE PERDA NOS OUTROS MODOS
          document.getElementById('colPerda').classList.remove('hidden');
      }
  }

  function simularCalculo() {
      const tipo = document.getElementById('tipoPeca').value;
      
      // LÓGICA RIGOROSA DE PERDA
      let perdaPerc = 0;
      if (tipo !== 'revestimento') {
          perdaPerc = parseFloat(document.getElementById('percPerda').value) || 0;
      }

      const densidade = parseFloat(document.getElementById('densidade').value) || 1.2;
      const markup = parseFloat(document.getElementById('markup').value) || 2.5;
      
      const selMat = document.getElementById('matSelect');
      if(selMat.selectedIndex < 0) return alert("Cadastre materiais na aba Custos primeiro!");
      const custoKg = parseFloat(selMat.value);
      const nomeMat = selMat.options[selMat.selectedIndex].text;
      const valorHora = window.marbeDB.custos.vh || 50;

      // Pegar Taxa de Imposto
      const taxaImposto = parseFloat(document.getElementById('tipoServicoCalc').value);
      const nomeServico = document.getElementById('tipoServicoCalc').options[document.getElementById('tipoServicoCalc').selectedIndex].text;

      let volumeCm3 = 0;
      let pesoDiretoG = 0;
      let descMedidas = "";

      // GEOMETRIA
      if (tipo === 'peso_direto') {
          pesoDiretoG = parseFloat(document.getElementById('peso-input').value);
          if(!pesoDiretoG) return alert("Informe o peso.");
          descMedidas = "Peso " + pesoDiretoG + "g";
      } 
      else if (tipo === 'revestimento') {
          const d = parseFloat(document.getElementById('rev-diam').value);
          const c = parseFloat(document.getElementById('rev-comp').value);
          const e = parseFloat(document.getElementById('rev-camada').value);
          if(d && c && e) {
              volumeCm3 = (Math.PI * (d + e) * e * c) / 1000;
              descMedidas = `Rev. Ø${d}x${c}mm (Camada ${e}mm)`;
          }
      }
      else if (tipo === 'retangular') {
          let c = parseFloat(document.getElementById('ret-comp').value), larg = parseFloat(document.getElementById('ret-larg').value), esp = parseFloat(document.getElementById('ret-esp').value);
          if(c && larg && esp) { volumeCm3 = (c*larg*esp)/1000; descMedidas = `${c}x${larg}x${esp}mm`; }
      } else if (tipo === 'quadrada') {
          let ld = parseFloat(document.getElementById('quad-lado').value), esp = parseFloat(document.getElementById('quad-esp').value);
          if(ld && esp) { volumeCm3 = (ld*ld*esp)/1000; descMedidas = `${ld}x${ld}x${esp}mm`; }
      } else if (tipo === 'redonda') {
          let d = parseFloat(document.getElementById('red-diam').value), esp = parseFloat(document.getElementById('red-esp').value);
          if(d && esp) { volumeCm3 = (Math.PI * Math.pow(d/2, 2) * esp)/1000; descMedidas = `Ø${d} x ${esp}mm`; }
      } else if (tipo === 'tubo') {
          let ext = parseFloat(document.getElementById('tubo-ext').value), int = parseFloat(document.getElementById('tubo-int').value), c = parseFloat(document.getElementById('tubo-comp').value);
          if(ext && int && c) {
              let area = (Math.PI * Math.pow(ext/2, 2)) - (Math.PI * Math.pow(int/2, 2));
              volumeCm3 = (area * c)/1000; descMedidas = `Ø${ext}xØ${int} x ${c}mm`;
          }
      } else if (tipo === 'oring') {
          let di = parseFloat(document.getElementById('oring-di').value), fio = parseFloat(document.getElementById('oring-fio').value);
          if(di && fio) {
              let rFio=fio/2, rMed=(di+fio)/2;
              volumeCm3 = (Math.PI * Math.pow(rFio, 2) * (2*Math.PI*rMed))/1000; descMedidas = `O-Ring Ø${di} x ${fio}mm`;
          }
      } else if (tipo === 'esfera') {
          let d = parseFloat(document.getElementById('esf-diam').value);
          if(d) { volumeCm3 = (4/3 * Math.PI * Math.pow(d/2, 3))/1000; descMedidas = `Esfera Ø${d}mm`; }
      } else if (tipo === 'cone') {
          let dm = parseFloat(document.getElementById('cone-maior').value), dmn = parseFloat(document.getElementById('cone-menor').value), h = parseFloat(document.getElementById('cone-alt').value);
          if(dm && dmn && h) {
              let r1=dm/2, r2=dmn/2;
              volumeCm3 = ((Math.PI*h)/3 * (Math.pow(r1,2) + r1*r2 + Math.pow(r2,2)))/1000; descMedidas = `Cone ${dm}/${dmn} x ${h}mm`;
          }
      }

      if(volumeCm3 === 0 && pesoDiretoG === 0) return alert("Preencha as medidas corretamente.");

      // CÁLCULO FINANCEIRO
      let pesoLiq = (tipo === 'peso_direto') ? pesoDiretoG : (volumeCm3 * densidade);
      let fatorPerda = 1 + (perdaPerc / 100);
      let pesoBrutoG = pesoLiq * fatorPerda;
      let pesoBrutoKg = pesoBrutoG / 1000;

      // 1. Custo Matéria Prima (Borracha)
      let custoMateria = pesoBrutoKg * custoKg;

      // 2. Custo Cola (Apenas para Revestimento: 10% da Borracha)
      let custoCola = 0;
      if (tipo === 'revestimento') {
          custoCola = custoMateria * 0.10;
          document.getElementById('linhaCola').classList.remove('hidden');
          document.getElementById('resCustoCola').innerText = window.fmtMoney(custoCola);
      } else {
          document.getElementById('linhaCola').classList.add('hidden');
      }

      // 3. Custo Mão de Obra
      let custoMO = 0;
      if (tipo === 'revestimento') {
          const hGastas = parseFloat(document.getElementById('horasGastas').value) || 0;
          if(!hGastas) return alert("Informe as horas gastas.");
          custoMO = valorHora * hGastas;
      } else {
          const pecasHora = parseFloat(document.getElementById('pecasHora').value);
          if(!pecasHora) return alert("Informe peças por hora.");
          custoMO = valorHora / pecasHora;
      }

      // 4. Custo Produção Total
      let custoProd = custoMateria + custoCola + custoMO;
      
      // 5. Markup (Venda Bruta)
      let precoBase = custoProd * markup;

      // 6. Imposto (Sobre o Preço Bruto)
      let valorImposto = precoBase * (taxaImposto / 100);

      // 7. Preço Final
      let precoFinal = precoBase + valorImposto;

      // AQUI É A MÁGICA: JÁ SALVA A DESCRIÇÃO COM A MEDIDA JUNTO
      ultimoCalculo = {
          n: `${document.getElementById('tipoPeca').options[document.getElementById('tipoPeca').selectedIndex].text} - ${nomeServico} ${descMedidas}`,
          mat: nomeMat, 
          med: descMedidas, 
          q: 1, 
          v: precoFinal, 
          kg_unit: pesoBrutoKg 
      };

      document.getElementById('resDesc').innerText = descMedidas;
      document.getElementById('resPesoLiq').innerText = pesoLiq.toFixed(1) + ' g';
      
      if(tipo === 'revestimento') {
          document.getElementById('lblPesoBruto').innerText = "Peso Bruto (s/ perda):";
      } else {
          document.getElementById('lblPesoBruto').innerText = `Peso Bruto (+${perdaPerc}%):`;
      }
      document.getElementById('resPesoBruto').innerText = pesoBrutoG.toFixed(1) + ' g';
      
      document.getElementById('resCustoMat').innerText = window.fmtMoney(custoMateria);
      document.getElementById('resCustoMO').innerText = window.fmtMoney(custoMO);
      document.getElementById('resCustoTot').innerText = window.fmtMoney(custoProd);
      
      document.getElementById('resMarkup').innerText = markup + "x (" + window.fmtMoney(precoBase) + ")";
      document.getElementById('resTaxa').innerText = taxaImposto;
      document.getElementById('resValorImposto').innerText = window.fmtMoney(valorImposto);

      document.getElementById('resPrecoVenda').innerText = window.fmtMoney(precoFinal);

      document.getElementById('boxResultado').classList.remove('hidden');
  }

  function adicionarAoOrcamento() {
      if(!ultimoCalculo) return;
      itensTemp.push({...ultimoCalculo}); 
      renderTabelaAtual(); tab('orc');
      document.getElementById('boxResultado').classList.add('hidden');
      ultimoCalculo = null;
  }

  // --- FUNÇÕES DE ORÇAMENTO E BANCO DE DADOS (Inalteradas) ---
  async function buscaCNPJ(v) {
    const cnpj = v.replace(/\D/g, ''); if (cnpj.length !== 14) return;
    try {
      const r = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`);
      const d = await r.json();
      document.getElementById('razao').value = d.razao_social || "";
      document.getElementById('endereco').value = d.logradouro ? `${d.logradouro}, ${d.numero} - ${d.bairro}, ${d.municipio} - ${d.uf}` : "";
    } catch (e) {}
  }

  function renderTabelaAtual() {
    let total = 0;
    document.getElementById('corpoAtual').innerHTML = itensTemp.map((it, i) => {
        total += it.v * it.q;
        return `<tr>
            <td><input class="editable-input" value="${it.n}" onchange="itensTemp[${i}].n=this.value"></td>
            
            <td style="font-size:9px">${it.mat}</td>
            
            <td><input type="number" class="editable-input" style="width:40px" value="${it.q}" onchange="itensTemp[${i}].q=parseInt(this.value); renderTabelaAtual()"></td>
            
            <td><input type="number" class="editable-input" style="width:80px" value="${it.v.toFixed(2)}" onchange="itensTemp[${i}].v=parseFloat(this.value); renderTabelaAtual()"></td>
            
            <td onclick="itensTemp.splice(${i},1);renderTabelaAtual()" style="cursor:pointer; color:red; font-weight:bold">X</td>
        </tr>`;
    }).join('');
    document.getElementById('totalOrc').innerText = window.fmtMoney(total);
  }

  function salvarOrcamento() {
    if(itensTemp.length === 0) return alert("Adicione pelo menos um item ao orçamento.");
    const orcData = { 
        os: idEdicao ? idEdicao.os : window.marbeDB.os, 
        cliente: document.getElementById('razao').value || "CLIENTE NÃO INFORMADO", 
        cnpj: document.getElementById('cnpj').value || "", 
        endereco: document.getElementById('endereco').value || "", 
        itens: JSON.parse(JSON.stringify(itensTemp)), 
        frete: document.getElementById('frete').value, 
        prazo: document.getElementById('prazo').value, 
        pagamento: document.getElementById('pagamento').value, 
        total: itensTemp.reduce((a,b)=>a+(b.v*b.q),0) 
    };
    if(idEdicao) {
        if(idEdicao.origem === 'pedidos') window.marbeDB.pedidos[idEdicao.index] = orcData;
        else window.marbeDB.orçamentos[idEdicao.index] = orcData;
        idEdicao = null; 
        document.getElementById('btnCancelaEdit').style.display = 'none'; 
        document.getElementById('osEdicaoLabel').innerText = "Nova";
    } else {
        if(!window.marbeDB.orçamentos) window.marbeDB.orçamentos = [];
        window.marbeDB.orçamentos.push(orcData); 
        window.marbeDB.os++;
    }
    window.salvarNuvem(); itensTemp = []; renderTabelaAtual(); tab('historico');
  }

  function renderOrcamentos() {
    document.getElementById('listaOrcamentos').innerHTML = (window.marbeDB.orçamentos || []).map((o, i) => `
      <div class="card-list">
        <strong>OS: ${o.os} - ${o.cliente}</strong><br>
        <span style="font-size:12px; color:#666">${window.fmtMoney(o.total)}</span><br>
        <div style="display:flex; gap:5px; margin-top:5px;">
            <button class="btn" style="background:var(--info); padding:8px; margin:0; font-size:10px;" onclick="gerarPDF('CLIENTE', ${i}, 'orçamentos')">PDF</button>
            <button class="btn" style="background:var(--prod); padding:8px; margin:0; font-size:10px;" onclick="gerarPDF('PRODUCAO', ${i}, 'orçamentos')">PROD</button>
            <button class="btn" style="background:var(--dark); padding:8px; margin:0; font-size:10px;" onclick="editarExistente('orçamentos', ${i})">EDITAR</button>
            <button class="btn" style="background:var(--success); padding:8px; margin:0; font-size:10px;" onclick="fecharPedido(${i})">FECHAR</button>
        </div>
      </div>`).join('');
  }

  function fecharPedido(i) {
    const orc = window.marbeDB.orçamentos.splice(i, 1)[0];
    if(!window.marbeDB.pedidos) window.marbeDB.pedidos = [];
    window.marbeDB.pedidos.push(orc); window.salvarNuvem(); tab('pedidos');
  }

  function renderPedidos() {
    document.getElementById('listaPedidos').innerHTML = (window.marbeDB.pedidos || []).map((p, i) => `
      <div class="card-list">
        <strong>OS: ${p.os} - ${p.cliente}</strong> | ${window.fmtMoney(p.total)}<br>
        <div style="display:flex; gap:5px; margin:5px 0;">
            <button class="btn" style="background:var(--info); width:auto; padding:8px; margin:0; flex:1" onclick="editarExistente('pedidos', ${i})">EDITAR/DESC.</button>
            <button class="btn" style="background:var(--dark); width:auto; padding:8px; margin:0; flex:1" onclick="gerarPDF('PRODUCAO', ${i}, 'pedidos')">PRODUÇÃO</button>
        </div>
        
        <button class="btn" style="background:var(--danger); margin-top:5px; padding:8px;" onclick="estornarVenda(${i})">↩ CANCELAR VENDA (VOLTAR)</button>
        <hr style="border:0; border-top:1px dashed #ccc; margin:10px 0;">

        <input type="text" id="nf_${i}" placeholder="Nº NF" style="margin-top:5px">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <input type="number" id="parc_${i}" placeholder="Qtd Parc.">
            <input type="date" id="data_${i}">
        </div>
        <button class="btn" style="background:var(--success)" onclick="faturar(${i})">FATURAR E ENTREGAR</button>
      </div>`).join('');
  }

  function estornarVenda(i) {
      if(!confirm("Deseja CANCELAR essa venda e voltar para Orçamento? O item sairá desta lista.")) return;
      
      const item = window.marbeDB.pedidos.splice(i, 1)[0];
      
      if(!window.marbeDB.orçamentos) window.marbeDB.orçamentos = [];
      window.marbeDB.orçamentos.push(item);
      
      window.salvarNuvem();
      updateUI();
      
      alert("Venda estornada! O item voltou para a aba HISTÓRICO.");
      tab('historico');
  }

  function faturar(i) {
    const nf = document.getElementById(`nf_${i}`).value, qtd = parseInt(document.getElementById(`parc_${i}`).value), dt = document.getElementById(`data_${i}`).value;
    if(!nf || !qtd || !dt) return alert("Preencha NF, Parcelas e Data!");
    const p = window.marbeDB.pedidos[i]; const dataBase = new Date(dt + "T12:00:00");
    if(!window.marbeDB.financeiro) window.marbeDB.financeiro = [];
    for(let j=0; j<qtd; j++) {
        let v = new Date(dataBase); v.setMonth(v.getMonth() + j);
        window.marbeDB.financeiro.push({ os: p.os, nf: nf, cliente: p.cliente, valor: p.total/qtd, venc: v.toLocaleDateString('pt-BR'), pago: false });
    }
    window.marbeDB.pedidos.splice(i, 1); window.salvarNuvem(); tab('financeiro');
  }

  function gerarPDF(tipo, index, base) {
    const { jsPDF } = window.jspdf; const doc = new jsPDF(); const d = window.marbeDB[base][index];
    const clean = (t) => t ? t.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase() : "";
    
    doc.setFontSize(10); doc.text("S B COMERCIO DE BORRACHAS E SERVICOS LTDA", 20, 15);
    
    if(tipo === 'PRODUCAO') {
        doc.text(`VIA PRODUCAO - OS: ${d.os}`, 20, 22);
        doc.text(`PRAZO ENTREGA: ${clean(d.prazo)}`, 20, 27);
        doc.autoTable({ 
            startY: 32, 
            head: [['ITEM', 'MAT.', 'QTD', 'KG TOTAL (c/ Perda)']], 
            body: d.itens.map(i => [clean(i.n), clean(i.mat), i.q, (i.kg_unit * i.q).toFixed(3) + " KG"]),
            theme: 'grid'
        });
    } else {
        // PDF DO CLIENTE
        doc.text(`ORCAMENTO - OS: ${d.os} | DATA: ${new Date().toLocaleDateString('pt-BR')}`, 20, 22);
        doc.text(`CLIENTE: ${clean(d.cliente)}`, 20, 27);
        doc.text(`CNPJ: ${d.cnpj || ""}`, 20, 31);
        doc.text(`ENDERECO: ${clean(d.endereco)}`, 20, 35);
        
        doc.autoTable({ 
            startY: 40, 
            head: [['DESCRICAO', 'QTD', 'V. UNIT', 'V. TOTAL']], 
            // Agora 'i.n' já contém a medida, então não preciso concatenar de novo
            body: d.itens.map(i => [
                clean(i.n), 
                i.q, 
                window.fmtMoney(i.v), 
                window.fmtMoney(i.v * i.q)
            ]),
            
            theme: 'striped',
            columnStyles: {
                0: { cellWidth: 'auto' }, 
                1: { cellWidth: 15, halign: 'center' }, 
                2: { cellWidth: 35, halign: 'right' },  
                3: { cellWidth: 35, halign: 'right' }   
            },
            styles: { fontSize: 9, cellPadding: 2 }
        });
        
        const fY = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(12);
        doc.text(`TOTAL GERAL: ${window.fmtMoney(d.total)}`, 190, fY, {align:'right'});
        
        doc.setFontSize(8); 
        doc.text(`FRETE: ${clean(d.frete)} | PRAZO: ${clean(d.prazo)}`, 20, fY + 5);
        doc.text(`PAGAMENTO: ${clean(d.pagamento)}`, 20, fY + 10);
    }
    window.abrirPDFMobile(doc.output('blob'), d.os);
  }

  function renderSuprimentos() {
    const necessidade = {};
    (window.marbeDB.pedidos || []).forEach(p => p.itens.forEach(it => {
        const mat = it.mat || "Nao identificado"; 
        necessidade[mat] = (necessidade[mat] || 0) + (it.kg_unit * it.q);
    }));
    let html = `<table><thead><tr><th>Material</th><th>Preciso</th><th>Estoque</th><th>Saldo</th></tr></thead><tbody>`;
    Object.keys(necessidade).forEach(mat => {
        const prec = necessidade[mat], comp = window.marbeDB.estoque[mat] || 0, saldo = comp - prec;
        html += `<tr><td>${mat}</td><td>${prec.toFixed(2)}kg</td><td><input type="number" value="${comp}" onchange="window.marbeDB.estoque['${mat}']=parseFloat(this.value); window.salvarNuvem();" style="width:60px"></td><td class="${saldo < 0 ? 'negativo' : 'positivo'}">${saldo.toFixed(2)}</td></tr>`;
    });
    document.getElementById('dashboardSuprimentos').innerHTML = Object.keys(necessidade).length ? html + "</tbody></table>" : "<p>Sem pedidos pendentes.</p>";
  }

  function renderCustos() {
    if(window.marbeDB.custos && window.marbeDB.custos.mats) {
        document.getElementById('listaCustos').innerHTML = window.marbeDB.custos.mats.map((m, i) => `
          <div style="display:flex; gap:5px; margin-bottom:5px;">
            <input value="${m.n}" readonly style="flex:2; background:#eee">
            <input value="${window.fmtMoney(m.p)}" readonly style="flex:1; background:#eee">
            <button onclick="window.marbeDB.custos.mats.splice(${i},1); window.salvarNuvem(); updateUI();" style="background:red; color:white; border:none; padding:5px; border-radius:4px; font-weight:bold">X</button>
          </div>`).join('');
    }
  }

  function addMaterial() {
    const n = document.getElementById('matNome').value, p = parseFloat(document.getElementById('matPreco').value);
    if(n && p) { 
        if(!window.marbeDB.custos.mats) window.marbeDB.custos.mats = [];
        window.marbeDB.custos.mats.push({n, p}); window.salvarNuvem(); 
        document.getElementById('matNome').value=""; document.getElementById('matPreco').value=""; 
        updateUI();
    }
  }

  function editarExistente(origem, index) {
      const base = window.marbeDB[origem][index]; idEdicao = { origem, index, os: base.os };
      document.getElementById('cnpj').value = base.cnpj || ""; document.getElementById('razao').value = base.cliente;
      document.getElementById('endereco').value = base.endereco || ""; document.getElementById('osEdicaoLabel').innerText = base.os;
      document.getElementById('btnCancelaEdit').style.display = 'block'; itensTemp = JSON.parse(JSON.stringify(base.itens));
      renderTabelaAtual(); tab('orc');
  }

  function cancelarEdicao() {
      idEdicao = null; itensTemp = []; document.getElementById('btnCancelaEdit').style.display = 'none';
      document.getElementById('osEdicaoLabel').innerText = "Nova"; renderTabelaAtual(); tab('calc');
  }

  function renderBoletos() {
    document.getElementById('listaBoletos').innerHTML = (window.marbeDB.financeiro || []).map((f, i) => `
    <div class="card-list"><strong>${f.cliente}</strong><br>OS: ${f.os} | NF: ${f.nf}<br>Valor: ${window.fmtMoney(f.valor)} | Venc: ${f.venc} <button class="btn" style="background:green; width:auto; display:inline-block; padding:6px; float:right; margin:0" onclick="window.marbeDB.financeiro[${i}].pago=true; window.salvarNuvem();">BAIXAR</button></div>`).join('');
  }
</script>
</body>
</html>
